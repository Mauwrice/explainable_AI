# Generate Heatmaps to Interpret the Models Predictions
To interpret how the voxels of the MRI scans impact the predicted class probability one can generate overlay heatmaps for the different scan slices. The utilized types are Occlusion and GradCam. 

The output of this will be compiled into a PDF.

## File Paths
Here we define two variables. 
* `INPUT_DIR`
  * Defines the location where the model weights, trained by [README-03-FIT-MODEL.md](README-03-FIT-MODEL.md), will be loaded from.
  * Defines the location where training results, generated in [README-04-ASSEMBLE-RESULTS.md](README-04-ASSEMBLE-RESULTS.md), WILL BE LOADED FROM
* `OUTPUT_DIR`
  * Defines the location where the analysis results will be saved to. This includes the heatmaps generated by Occlusion and GradCam.

## Defining The Parameters for the Analysis
The following variables should be set to create an analysis:
* `version`: The kind of model trained, for example: "CIBLSX"
* `generate_heatmap_and_save`: If true, then new heatmaps are generated and saved. If false, previously generated heatmaps are  loaded.
* `generate_pictures`: If true, pictures are generated. If false, pictures are not generated.
* `only_wrong_out`: If true, only patients that have been predicted wrong will be included into the pdf. Otherwise all patients will be included.
* `model_version`: Defines the model version to be loaded.
* `ens_mode`: Either `avg` or `wgt`. Defines how the ensemble should be weighted to generate the heatmap. Average or weighted. 
* `hm_type`: Either `gc` or `oc`. Defines if GradCam or occlusion heatmaps are generated.
* `norm_hm`: Boolean. Defines if the heatmaps are normalized. Occlusions are not normalized while GradCams are normalized.
* `pred_hm_only`: Boolean. If true, the heatmap of the prediction will be generated. If false, the positive and negative heatmaps are shown.
* `last_layer_only`: Boolean, If true, only the CNN's last layer will be used for the GradCam. If false, there will be an output for the last layer as well as for all layers.
* `comp_mode`: Compatibility mode. This Boolean should be set ``false`` for model version `CIBLSX >= 3` and `CIB >= 2`, otherwise ``true`` for previous versions. 

## Loading Artifacts
`rdat.version_setup(...)` will load the patients brain volumes, the tabular data normalized and unnormalized, and the model results generated in [result_assembly_fin.ipynb](result_assembly_fin.ipynb).

## Model
The empty model will be initialized according to the parameters set.

### Loading the Ensemble Members 
According to the previously provided information `gc.get_img_and_models` will create lists of tabular data, the brain volume, and the ensemble members. From this information the correct models will be loaded.

### Calculating the Heatmaps
For each patient either GradCam or Occlusion algorithm will be applied. This takes into consideration all models of the ensemble.

If the variable `generate_heatmap_and_save` is set to ``true`` then new heatmaps will be generated and saved. If the variable is set to ``false`` then the existing heatmaps will be loaded.

#### GradCam
Here it is possible to calculate the heatmap for the activations of either the just the last layer or the activations of both the last layer and all layers. 

Depending on the bool `norm_hm` there is a min/max normalization applied to the last-layer GradCam heatmaps. These min and max values is calculated over all patients within a run.

#### Occlusion
The occlusion size is `(18, 18, 4)` and the stride is `(10, 10, 3)`.

### Results
The results are appended to the existing results and saved to a new data frame. `res_table["heatmap_std_last_layer"]` stands for the standard deviation of the of the heatmaps. `res_table["heatmap_unc_last_layer"]` stands for the normalized (normalized with max/min of all "heatmap_std_last_layer") standard deviation of the heatmaps.

After determining the heatmaps their uncertainty is calculated. The uncertainty is the normalized min/max-averaged standard deviation over each pixel.

We also compare the prediction uncertainty with the heatmap uncertainty.

The resulting heatmaps will be saved as `.npy` files.

If `generate_pictures` is set to `true` heatmaps for each patient is also saved as `.png`.

### Visualization
The two average heatmaps for patient classes 0 and 1 can be visualized. 

Depending on the value of `only_wrong_out` the `.pdf` that is generated contains only patients that have a wrong prediction or all patients.